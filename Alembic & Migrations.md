[[Back End- Deep dive]]
#miscellaneous 

Alembic è uno strumento di migrazione del database per Python, usato comunemente insieme a SQLAlchemy, l'ORM (Object Relational Mapper) più diffuso in ambito Python.

## A cosa serve Alembic?

Alembic ti permette di gestire l'evoluzione dello SCHEMA di un database nel tempo. In pratica, quando modifichi i modelli del tuo database (ad esempio aggiungi una colonna o una tabella), Alembic può:

- generare script di migrazione (automaticamente o manualmente),

- applicare questi script al database,

- tenere traccia della versione dello schema del database.

## Esempio pratico:

Supponi di avere un'app FastAPI con SQLAlchemy, e inizialmente un modello User con solo id e name. Dopo un po' vuoi aggiungere l’email. Senza Alembic, dovresti scrivere a mano il comando SQL per modificare la tabella.

Con Alembic puoi fare:

1. Crea la nuova classe python del db

2. Crei la revisione con le nuove modifiche. Hai due possibilità:

3. Generarla in automatico (utile quando cambia STRUTTURA):

```bash

# crea il db con quanto rappresentato in models

alembic revision --autogenerate -m "Aggiunta colonna email a User"

```

2. Generarla a mano (utile quando devi popolare con dei DATI)

3. Invia la revisione e alembic aggiorna il DB:

```bash

alembic upgrade head # salva un eventuale modifica fatta a models


# ALTERNATIV (Utile quando fai bridge e ti ritrovi ad avere 2 head, in quanto passi da avere a->b->c ad avere a->c e quindi sia b che c risultano head)

alembic upgade <id_revision>

```

4. Definisci le funzioni CRUD (`get,put`) per aggiornare la nuova classe sul DB

  
#### Popolare il db con le sessioni
Se vuoi aggiungere dei dati, devi creare una nuova revision in cui a mano fai `INSERT INTO`. 
Per esempio:
```python
"""Added session names
Revision ID: 8b5924f77c92
Revises: 9a74baa685f4
Create Date: 2025-07-18 11:36:34.780572
"""
from typing import Sequence, Union
from datetime import datetime, timezone
from alembic import op
import sqlalchemy as sa
import sqlmodel
from common.dependencies.ai.scripts.baseline.policies import POLICIES
from common.dependencies.ai.scripts.baseline.prompts.policy_checking import PROMPTS
from common.dependencies.db.db_models import CommercialConditionType
# revision identifiers, used by Alembic.
revision: str = "8b5924f77c92"             <- Creazione del brige "a mano"
down_revision: Union[str, None] = "9a74baa685f4"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None

def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "check_session",
        sa.Column(
            "session_name",
            sqlmodel.sql.sqltypes.AutoString(length=100),
            nullable=False,
            default="Unnamed session",
        ),
    )
    populate_db()       <-chiamata inserita a mano
    
    # ### end Alembic commands ###
    Da qui in poi ste funzioni le ho scritte io
def populate_db() -> None:
    """Populate tables with default values"""
    _populate_commercial_conditions()
    _populate_prompts()
    
def _populate_commercial_conditions():
    """Populate the commercial_conditions table with data from POLICIES."""
    commercial_conditions_table = sa.table(
        "commercial_conditions",
        sa.column("id", sa.Integer),
        sa.column("name", sa.String),
        sa.column("type", sa.Enum(CommercialConditionType)),
        sa.column("description", sa.String),
        sa.column("priority", sa.String),
        sa.column("task_description", sa.String),
        sa.column("is_active", sa.Boolean),
        sa.column("created_at", sa.DateTime(timezone=True)),
    )
    current_time = datetime.now(timezone.utc)
    conditions_to_insert = [
        {
            "id": int(policy_id),
            "name": policy_data["commercial_condition_name"],
            "type": policy_data["commercial_condition_type"],
            "description": policy_data["commercial_condition_description"],
            "priority": policy_data["commercial_condition_priority"],
            "task_description": policy_data.get(
                "commercial_condition_task_description", ""
            ),
            "is_active": True,
            "created_at": current_time,
        }
        for policy_id, policy_data in POLICIES.items()
    ]
    if conditions_to_insert:
        op.bulk_insert(commercial_conditions_table, conditions_to_insert)
        
def _populate_prompts():
    """Populate the prompts table with data from PROMPTS."""
    prompts_table = sa.table(
        "prompts",
        sa.column("prompt_header", sa.String),
        sa.column("prompt_body", sa.String),
        sa.column("prompt_footer", sa.String),
        sa.column("agent_name", sa.String),
        sa.column("description", sa.String),
        sa.column("created_at", sa.DateTime(timezone=True)),
    )
    current_time = datetime.now(timezone.utc)
    prompts_to_insert = [
        {
            "prompt_header": prompt_data["prompt_header"],
            "prompt_body": prompt_data["prompt_body"],
            "prompt_footer": prompt_data["prompt_footer"],
            "agent_name": prompt_data["agent_name"],
            "description": prompt_data["description"],
            "created_at": current_time,
        }
        for _, prompt_data in PROMPTS.items()
    ]
    if prompts_to_insert:
        op.bulk_insert(prompts_table, prompts_to_insert)
        
def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("check_session", "session_name")
    # ### end Alembic commands ###
```

Componenti chiave:

- `alembic.ini` – file di configurazione.

- `versions/` – directory che contiene tutti gli script di migrazione.

- `env.py` – script che collega Alembic alla tua app e a SQLAlchemy.

Con `downgrade()`puoi annullare le modifiche fatte nell'`upgrade()`e spostare il puntatore alla penultima revisione ma è importante esplicitare tutto il codice di `undo` dentro `downgrade`.

### Aggiornare i prompt a DB in prod

1. Modifica sul db in prod i prompts

2. Nella tua storia di revisions aggiorna `upgrade()`dell'ultima revisione con il prompt modificato

3. Quando poi farà una modifica e deployerai, allora anche la nuova revisione sarà deployata

### IMPORTANTE

Il sincronismo è nella tabella `alembic_version` in cui c'è l'ultima versione di alembic che è stata eseguita.

Se da errore di version non trovata, è perchè nella tabella `alembic_version`, lui punta ad un'altra version che non è l'ultima che hai tu, quindi va sostituita.

## In sintesi:

Alembic è lo strumento standard per le migrazioni di schema nei progetti Python che usano SQLAlchemy. Ti consente di gestire in modo ordinato e sicuro le modifiche al database nel tempo.
